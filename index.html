<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>

<body>
	<script>
		// polyfill: 垫片
		// 面试题
		//1executor 执行器函数
		//2resolve 把promise变成成功态 reject 把promise变成失败态
		//3value 记录成功的原因 reason:失败的原因
		//4promise有三种状态 pending准备态 fuiflled 完成态 rejected拒绝态
		//5promise状态只能改变一次，pending-->fuiflled pending-->rejected 不能 完成态 拒绝态相互转换
		//6promise 执行的过程中 任何错误都会导致promise变成失败态
		//7promise必须有then方法，onFUFILLED成功的回调, onREJECTED失败的回调
		//8设计模式:发布订阅模式：订阅一下行为，再再合适时机去执行(发布)
		// -最简单的；DOM事件 /vue当中的自定义事件：$emit事件 /eventBus/ Promise异步的时候
		//9promise除了链式调用以外还可以多次调用
		const PENDING = 'pending'
		const FUFILLED = 'fuiflled'
		const REJECTED = 'rejected'
		class Promise {
			value
			reason
			status = PENDING
			onFuiflled
			onRejected
			onFuiflledCallBack = []// 成功
			onRejectedCallBack = []// 失败
			constructor(executor) {
				const resolve = (value) => {
					if (this.status === PENDING) {
						this.value = value
						this.status = FUFILLED
						// this.onFuiflled(this.value)
						this.onFuiflledCallBack.forEach(cb => cb())
					}
				}
				const reject = (reason) => {
					if (this.status === PENDING) {
						this.reason = reason
						this.status = REJECTED
						// this.onRejected(this.reason)
						this.onRejectedCallBack.forEach(cd => cd())
					}
				}
				try {
					executor(resolve, reject)
				} catch (error) {
					reject(error)
				}
			}
			then(onFuiflled, onRejected) {
				if (this.status === FUFILLED) {
					onFuiflled(this.value)
				}
				if (this.status === REJECTED) {
					onRejected(this.reason)
				}
				// 异步 订阅
				if (this.status === PENDING) {
					// this.onFuiflled = onFuiflled
					// this.onRejected = onRejected
					this.onFuiflledCallBack.push(() => {
						onFuiflled(this.value)
					})
					this.onRejectedCallBack.push(() => {
						onRejected(this.reason)
					})
				}
			}
		}

		//--------------------------
		// console.log(new Promise((resolve, reject) => {
		//// 	resolve('成功')
		// 	reject('失败')
		// }));
		//--------------------------
		// const p1 = new Promise(() => { }) //Pending
		// const p2 = new Promise((resolve) => resolve()) // fulfilled
		// const p3 = new Promise((resolve, reject) => reject()) // rejected

		// console.log(
		// 	'p1', p1,
		// 	'p2', p2,
		// 	'p3', p3
		// )
		//----------------------
		// const p = new Promise((resolve, reject) => {
		// 	throw new Error()
		// 	// resolve('成功')
		// 	// reject('失败')
		// });
		// console.log(p);
		//-----------------------
		// const p = new Promise((resolve, reject) => {
		// 	resolve('成功')
		// 	// reject('失败')
		// });
		// p.then(
		// 	(res) => console.log(res),
		// 	(err) => console.log(err)
		// )
		//--------------------
		// const p = new Promise((resolve, reject) => {
		// 	setTimeout(() => {
		// 		// resolve('你好')
		// 		reject('失败')
		// 	}, 1000)
		// });
		// p.then(
		// 	(res) => console.log(res),
		// 	(err) => console.log(err)
		// )
		//--------------------
		const p = new Promise((resolve, reject) => {
			setTimeout(() => {
				resolve('成功') // 异步情况
			}, 1000)
		});
		p.then(
			(res) => console.log('第一次then', res),
		)
		p.then(
			(err) => console.log('第二次then', err)
		)
	</script>
</body>

</html>